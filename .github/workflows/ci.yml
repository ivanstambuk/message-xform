name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle.kts', 'gradle/libs.versions.toml') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Spotless Check (formatting)
        run: ./gradlew --no-daemon spotlessCheck

      - name: Build & Test
        run: ./gradlew --no-daemon check

      - name: Commit message lint
        if: github.event_name == 'pull_request'
        run: |
          # Validate the latest commit message against conventional format
          TITLE=$(git log -1 --format='%s')
          TYPES="fix|feat|docs|refactor|retro|session|backlog|terminology|test|chore"
          if ! echo "$TITLE" | grep -qE "^($TYPES)(\([a-zA-Z0-9_-]+\))?: .+"; then
            echo "❌ Commit message does not follow conventional format: $TITLE"
            exit 1
          fi
          TITLE_LEN=${#TITLE}
          if [ "$TITLE_LEN" -gt 72 ]; then
            echo "❌ Commit title too long: $TITLE_LEN chars (max 72)"
            exit 1
          fi

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Build Shadow JAR
        run: ./gradlew --no-daemon :adapter-standalone:shadowJar

      - name: Build Docker image
        run: docker build -t message-xform-proxy -f adapter-standalone/Dockerfile .

      - name: Verify image size
        run: |
          SIZE=$(docker image inspect message-xform-proxy --format='{{.Size}}')
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Docker image size: ${SIZE_MB} MB"
          if [ "$SIZE_MB" -gt 150 ]; then
            echo "❌ Image exceeds 150 MB limit"
            exit 1
          fi
          echo "✅ Image size OK (< 150 MB)"

      - name: Smoke test
        run: |
          docker run -d --name proxy-test -p 18080:8080 message-xform-proxy
          sleep 3
          STATUS=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:18080/health || true)
          docker logs proxy-test
          docker rm -f proxy-test
          if [ "$STATUS" != "200" ]; then
            echo "❌ Health check failed (status: $STATUS)"
            exit 1
          fi
          echo "✅ Health check passed"
