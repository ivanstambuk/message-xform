# Platform transform profile — routes specs to AM authentication API paths
#
# This profile implements the clean API surface for authentication endpoints
# fronted by PingAccess. Uses profile-level chaining (ADR-0008) to separate
# concerns and body-predicate routing (ADR-0036, match.when) to discriminate
# between WebAuthn and login callback responses.
#
# ── URL Routing (request-side) ──
#
# Clean URLs are rewritten to AM's /json/authenticate endpoint:
#
#   /api/v1/auth/passkey/usernameless → /am/json/authenticate + UsernamelessJourney
#   /api/v1/auth/passkey              → /am/json/authenticate + WebAuthnJourney
#   /api/v1/auth/login                → /am/json/authenticate (default tree)
#
# These request-side specs only rewrite the URL and inject headers — the
# request body passes through unchanged (D9).
#
# After the URL rewrite, the PA adapter sets request.setUri() which means
# the response-side transforms see the REWRITTEN path (/am/json/authenticate)
# and match correctly.
#
# ── Response Routing (body predicates) ──
#
#   Has TextOutputCallback with "navigator.credentials"?
#     YES → am-webauthn-response (passkey registration/authentication)
#     NO  → am-auth-response-v2  (login callbacks + success responses)
#
#   Both routes chain into am-strip-internal to remove _-prefixed fields.
#
# AM paths arrive as /am/json/... through the PA reverse proxy.
#

profile: platform-am
version: "4.0.0"
description: "Clean API surface for PingAM authentication via PingAccess"

transforms:
  # ══════════════════════════════════════════════════════════════════════
  # REQUEST-SIDE: Clean URL → AM endpoint rewriting
  # ══════════════════════════════════════════════════════════════════════

  # ── Passkey usernameless (most specific path first) ──
  - spec: am-passkey-usernameless-url@1.0.0
    direction: request
    match:
      path: "/api/v1/auth/passkey/usernameless"
      method: POST

  # ── Passkey identifier-first ──
  - spec: am-passkey-url@1.0.0
    direction: request
    match:
      path: "/api/v1/auth/passkey"
      method: POST

  # ── Login (default tree) ──
  - spec: am-auth-url-rewrite@1.0.0
    direction: request
    match:
      path: "/api/v1/auth/login"
      method: POST

  # ══════════════════════════════════════════════════════════════════════
  # RESPONSE-SIDE: Body transforms on AM responses
  # ══════════════════════════════════════════════════════════════════════

  # ── Step 1a: WebAuthn body transform ──
  # Parses embedded JavaScript from WebAuthn callbacks into structured JSON.
  # Matched by body predicate: TextOutputCallback contains navigator.credentials.
  - spec: am-webauthn-response@1.0.0
    direction: response
    match:
      path: "/am/json/authenticate"
      method: POST
      when:
        lang: jslt
        expr: |
          .callbacks and
            size([for (.callbacks) .
              if (.type == "TextOutputCallback" and
                  test(.output[0].value, "navigator\\.credentials"))]) > 0

  # ── Step 1b: Login body transform ──
  # Converts AM callback/success responses into clean JSON.
  # Excludes WebAuthn callbacks (routed to step 1a above).
  - spec: am-auth-response-v2@1.0.0
    direction: response
    match:
      path: "/am/json/authenticate"
      method: POST
      when:
        lang: jslt
        expr: |
          not(.callbacks) or
            size([for (.callbacks) .
              if (.type == "TextOutputCallback" and
                  test(.output[0].value, "navigator\\.credentials"))]) == 0

  # ── Step 2: Strip internal fields ──
  # Removes _-prefixed fields from the response body.
  # Runs AFTER step 1a or 1b (profile-level chaining per ADR-0008).
  - spec: am-strip-internal@1.0.0
    direction: response
    match:
      path: "/am/json/authenticate"
      method: POST
